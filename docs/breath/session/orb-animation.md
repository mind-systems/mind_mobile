# OrbAnimationCoordinator и анимация размера EclipseOrb

## Роль в системе

Рядом с BreathAnimationCoordinator, который отвечает за движение точки и морфинг фигуры, существует OrbAnimationCoordinator — отдельный координатор, который отвечает исключительно за размер EclipseOrb. Оба координатора подписаны на одни и те же источники данных — Riverpod-стейт ViewModel и стабильный resetStream, — но управляют разными визуальными объектами и не знают друг о друге.

## Как EclipseOrb меняет размер

EclipseOrb получает параметр size, который задаёт физический размер виджета в пикселях. Вся внутренняя математика орба — расположение орбов, радиус маски, свечение, атмосферный ореол — вычисляется относительно этого размера, поэтому при его изменении весь визуальный эффект масштабируется пропорционально. Пульсация продолжает работать поверх этого масштабирования независимо.

OrbAnimationCoordinator владеет ValueNotifier<double> orbProgress со значением от 0.2 до 1.0. В экране этот нотифайер подключён через ValueListenableBuilder, который передаёт текущее значение как size: shapeDimension * progress. Таким образом, минимальный размер орба — 20% от ширины контейнера фигуры, максимальный — 100%.

## Логика вычисления прогресса

На каждый Riverpod-стейт координатор смотрит на текущую фазу и статус сессии. Если статус не breath или фаза не inhale и не exhale — orbProgress не обновляется и орб остаётся на последнем значении.

При inhale координатор вычисляет phaseRaw как долю прошедшего времени от начала фазы: (total - remaining) / total. Это значение映射ется в диапазон [minProgress, maxProgress] линейным интерполированием — орб растёт от минимального размера к максимальному по мере вдоха. При exhale та же формула применяется в обратную сторону — орб сжимается от максимума к минимуму.

Максимальный размер зависит от формы текущего упражнения. Для круга он равен 0.8, то есть 80% от контейнера фигуры, для всех остальных форм — 1.0. Это решение принято по визуальным соображениям: круглая фигура дыхания занимает всё пространство контейнера, и орб на 100% перекрывал бы её целиком.

## Смена упражнения и рестарт

Когда приходит событие в resetStream, координатор обновляет maxProgress для следующей формы и немедленно возвращает orbProgress к minProgress. Это предотвращает резкий визуальный скачок: в момент начала нового упражнения орб всегда маленький, и затем плавно вырастает с первым вдохом.

При рестарте сессии Screen вызывает orbCoordinator.reset() перед viewModel.restart(). Координатор возвращает orbProgress к minProgress и сбрасывает флаг _resetStreamSubscribed, после чего следующий ready-стейт инициализирует maxProgress для новой сессии точно так же, как при первом старте.

## Lazy-инициализация resetStream

При вызове initialize сессия может ещё не быть загружена — стейт-машина создаётся асинхронно. Поэтому resetStream в этот момент может быть пустым и не иметь подключённого контроллера. Координатор использует тот же guard-паттерн, что и BreathAnimationCoordinator: при первом ready-стейте он переподписывается на resetStream и устанавливает maxProgress. После этого флаг _resetStreamSubscribed выставляется в true, и повторная переподписка не происходит.
