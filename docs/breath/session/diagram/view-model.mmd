flowchart TD
    classDef lifecycle fill:#e8f5e9,stroke:#4caf50,stroke-width:2px,color:#1b5e20
    classDef tick fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#e65100
    classDef transition fill:#e3f2fd,stroke:#2196f3,stroke-width:2px,color:#0d47a1
    classDef helper fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px,color:#4a148c
    classDef external fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f

    %% Внешние триггеры
    TickService["TickService<br/>(внешний метроном)"]:::external
    UI["UI Screen<br/>(pause/resume)"]:::external

    %% Lifecycle методы
    initState["initState()<br/>───<br/>Стартовая точка"]:::lifecycle
    pause["pause()<br/>───<br/>Останавливает движение"]:::lifecycle
    resume["resume()<br/>───<br/>Возобновляет движение"]:::lifecycle
    complete["complete()<br/>───<br/>Завершает сессию"]:::lifecycle

    %% Tick обработчики
    onTick["_onTick(TickData)<br/>───<br/>Главный диспетчер"]:::tick
    onBreathTick["_onBreathTick()<br/>───<br/>Обрабатывает дыхательную фазу<br/>_cycleTick++"]:::tick
    onRestTick["_onRestTick()<br/>───<br/>Обрабатывает отдых<br/>_cycleTick++"]:::tick

    %% Transition методы
    startRest["_startRest()<br/>───<br/>Переход в режим отдыха<br/>resetStream.add()<br/>_cycleTick = 0"]:::transition
    startNewCycle["_startNewCycle()<br/>───<br/>Новый цикл дыхания<br/>resetStream.add()<br/>_cycleTick = 0"]:::transition
    advanceExercise["_advanceExercise()<br/>───<br/>Следующее упражнение<br/>resetStream.add()<br/>_exerciseIndex++"]:::transition

    %% Helper методы
    getCurrentStepData["_getCurrentStepData(tick)<br/>───<br/>Определяет текущий шаг<br/>по _cycleTick"]:::helper
    mapStepType["_mapStepTypeToPhase()<br/>───<br/>StepType → BreathPhase"]:::helper
    resetCycleInternal["_resetCycleInternal()<br/>───<br/>_cycleTick = 0<br/>_repeatCounter = 0"]:::helper

    %% Публичные методы для UI
    getCurrentPhaseInfo["getCurrentPhaseInfo()<br/>───<br/>Возвращает текущую фазу<br/>+ оставшиеся тики"]:::helper
    getNextPhaseInfo["getNextPhaseInfo()<br/>───<br/>Прогноз следующей фазы<br/>для UI"]:::helper

    %% Основной поток
    TickService -->|"tick every ~1s"| onTick
    UI -->|"user action"| pause
    UI -->|"user action"| resume

    initState -->|"setup first phase"| getCurrentStepData
    getCurrentStepData -->|"inhale/hold/exhale"| mapStepType

    onTick -->|"if status == breath"| onBreathTick
    onTick -->|"if status == rest"| onRestTick

    %% Логика дыхательного тика
    onBreathTick -->|"_cycleTick >= cycleDuration?"| CheckCycleEnd{"Цикл завершён?"}
    CheckCycleEnd -->|"да: _repeatCounter++"| CheckRepeatEnd{"Все повторы?"}
    CheckRepeatEnd -->|"да"| advanceExercise
    CheckRepeatEnd -->|"нет: restDuration > 0?"| CheckRestNeeded{"Нужен отдых?"}
    CheckRestNeeded -->|"да"| startRest
    CheckRestNeeded -->|"нет"| startNewCycle

    CheckCycleEnd -->|"нет: продолжаем"| getCurrentStepData
    getCurrentStepData -->|"обновляем state"| UpdateState["state = new BreathSessionState()"]

    %% Логика тика отдыха
    onRestTick -->|"_cycleTick >= restDuration?"| CheckRestEnd{"Отдых завершён?"}
    CheckRestEnd -->|"да: steps.isEmpty?"| CheckRestType{"Тип отдыха?"}
    CheckRestType -->|"отдельное упражнение"| advanceExercise
    CheckRestType -->|"между циклами"| startNewCycle
    CheckRestEnd -->|"нет: продолжаем"| UpdateState

    %% Переходы
    advanceExercise -->|"_exerciseIndex >= length?"| CheckSessionEnd{"Сессия завершена?"}
    CheckSessionEnd -->|"да"| complete
    CheckSessionEnd -->|"нет"| resetCycleInternal
    resetCycleInternal -->|"next.steps.isEmpty?"| CheckNextType{"Следующее = отдых?"}
    CheckNextType -->|"да"| startRest
    CheckNextType -->|"нет"| startNewCycle

    startRest -->|"emit reset signal"| UpdateState
    startNewCycle -->|"emit reset signal"| getCurrentStepData

    %% UI запросы
    UI -.->|"getCurrentPhaseInfo()"| getCurrentPhaseInfo
    UI -.->|"getNextPhaseInfo()"| getNextPhaseInfo
    getCurrentPhaseInfo -.->|"вычисляет по _cycleTick"| getCurrentStepData
    getNextPhaseInfo -.->|"заглядывает вперёд"| getCurrentStepData

    %% Ключевые переменные
    Variables["<b>Ключевые переменные:</b><br/>─────────────<br/>_exerciseIndex: какое упражнение<br/>_repeatCounter: какой повтор<br/>_cycleTick: позиция внутри цикла"]

    style Variables fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#3e2723,text-align:left

    Variables -.->|"используются в"| onBreathTick
    Variables -.->|"используются в"| onRestTick
    Variables -.->|"используются в"| getCurrentStepData