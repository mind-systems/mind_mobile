flowchart TD
    classDef external fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#e65100
    classDef vm fill:#e3f2fd,stroke:#2196f3,stroke-width:2px,color:#0d47a1
    classDef machine fill:#e8f5e9,stroke:#4caf50,stroke-width:2px,color:#1b5e20
    classDef consumer fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px,color:#4a148c
    classDef stream fill:#ffebee,stroke:#f44336,stroke-width:2px,color:#b71c1c

    %% === –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ===
    ITickService["<b>ITickService</b><br/>tickStream"]:::external
    IBreathSessionService["<b>IBreathSessionService</b><br/>getSession(id): Future&lt;DTO&gt;"]:::external
    Screen["<b>BreathSessionScreen</b><br/>–≤—ã–∑—ã–≤–∞–µ—Ç: pause / resume<br/>restart / initState"]:::external

    %% === BreathViewModel ===
    subgraph VM["üéØ BreathViewModel (StateNotifier)"]
        direction TB

        initState["initState()<br/>‚îÄ‚îÄ‚îÄ<br/>async: getSession() ‚Üí DTO<br/>–∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ _sessionDTO<br/>‚Üí _setupEngine(dto)"]:::vm

        setupEngine["_setupEngine(dto)<br/>‚îÄ‚îÄ‚îÄ<br/>dispose() —Å—Ç–∞—Ä–æ–≥–æ StateMachine<br/>—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π StateMachine<br/>–ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç proxy<br/>—ç–º–∏—Ç–∏—Ç Riverpod state (ready)"]:::vm

        onEngineState["_onEngineState(state)<br/>‚îÄ‚îÄ‚îÄ<br/>–æ–±–Ω–æ–≤–ª—è–µ—Ç timelineSteps<br/>‚Üí —ç–º–∏—Ç–∏—Ç Riverpod state"]:::vm

        restart["restart()<br/>‚îÄ‚îÄ‚îÄ<br/>_setupEngine(_sessionDTO!)<br/>–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π DTO"]:::vm

        facade["Facade –º–µ—Ç–æ–¥—ã<br/>‚îÄ‚îÄ‚îÄ<br/>currentExercise<br/>getCurrentPhaseInfo()<br/>getCurrentPhaseMeta()<br/>getNextPhaseInfo()<br/>getNextExerciseWithShape()"]:::vm
    end

    %% === StateMachine (—Å–æ–∑–¥–∞—ë—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ VM) ===
    subgraph SM["‚öôÔ∏è BreathSessionStateMachine (—Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ _setupEngine)"]
        direction LR
        SMState["stateStream<br/>Stream&lt;StateMachineState&gt;"]:::machine
        SMReset["resetStream<br/>Stream&lt;ResetReason&gt;"]:::machine
    end

    %% === Proxy-—Å—Ç—Ä–∏–º—ã ViewModel ===
    ResetController["_resetController<br/>‚îÄ‚îÄ‚îÄ<br/>StreamController.broadcast()<br/>–ñ–∏–≤—ë—Ç –≤–µ—Å—å lifecycle VM<br/>–°—Ç–∞–±–∏–ª–µ–Ω –ø—Ä–∏ restart()"]:::stream
    RiverpodState["Riverpod State<br/>‚îÄ‚îÄ‚îÄ<br/>BreathSessionState<br/>loadState / status / phase<br/>remainingTicks / timelineSteps"]:::stream

    %% === –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ ===
    Coordinator["<b>BreathAnimationCoordinator</b><br/>–°–ª—É—à–∞–µ—Ç Riverpod state<br/>–°–ª—É—à–∞–µ—Ç viewModel.resetStream"]:::consumer

    %% === –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö ===

    %% –ó–∞–≥—Ä—É–∑–∫–∞
    IBreathSessionService -->|"async getSession()"| initState
    ITickService -->|"tickStream"| SM

    %% –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    Screen -->|"initState()"| initState
    initState -->|"–∑–∞–≥—Ä—É–∑–∏–ª DTO"| setupEngine
    setupEngine -->|"—Å–æ–∑–¥–∞—ë—Ç"| SM

    %% Proxy pattern: SM ‚Üí VM ‚Üí –Ω–∞—Ä—É–∂—É
    SMState -->|"_engineSubscription.listen()"| onEngineState
    onEngineState -->|"state.copyWith()"| RiverpodState
    SMReset -->|"_resetProxySubscription.listen()"| ResetController

    %% –ü—É–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∏–º—ã VM
    ResetController -->|"viewModel.resetStream"| Coordinator
    RiverpodState -->|"Riverpod listener"| Coordinator

    %% –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    Screen -->|"pause() / resume() / complete()"| SM
    Screen -->|"restart()"| restart
    restart -->|"_setupEngine(cached DTO)"| setupEngine

    %% Facade –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ SM
    facade -.->|"–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç"| SM

    %% === –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è: –∑–∞—á–µ–º proxy ===
    ProxyNote["<b>–ó–∞—á–µ–º _resetProxySubscription?</b><br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>–ü—Ä–∏ restart() StateMachine –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è.<br/>–ï–≥–æ resetStream –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –Ω–æ–≤—ã–π ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è.<br/>_resetController –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–º –∂–µ –æ–±—ä–µ–∫—Ç–æ–º.<br/>Coordinator –ø–æ–¥–ø–∏—Å–∞–Ω –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Ä–≤—ë—Ç—Å—è.<br/>_resetProxySubscription –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤ _setupEngine()."]

    style ProxyNote fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#3e2723,text-align:left
