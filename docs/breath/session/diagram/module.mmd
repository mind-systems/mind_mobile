flowchart TB
    classDef model fill:#e8f5e9,stroke:#4caf50,stroke-width:2px,color:#1b5e20
    classDef service fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#e65100
    classDef viewmodel fill:#e3f2fd,stroke:#2196f3,stroke-width:2px,color:#0d47a1
    classDef animation fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px,color:#4a148c
    classDef ui fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#880e4f
    classDef stream fill:#ffebee,stroke:#f44336,stroke-width:2px,color:#b71c1c

    %% === Ğ¡Ğ›ĞĞ™ ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™ ===
    subgraph Models["ğŸ“¦ Models Layer"]
        direction TB
        ExerciseStep["<b>ExerciseStep</b><br/>â”€â”€â”€<br/>type: inhale/hold/exhale<br/>duration: int (Ñ‚Ğ¸ĞºĞ¸)"]:::model
        ExerciseSet["<b>ExerciseSet</b><br/>â”€â”€â”€<br/>steps: List&lt;ExerciseStep&gt;<br/>restDuration: int<br/>repeatCount: int<br/>â”€â”€â”€<br/>cycleDuration: Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ğ¾Ğµ<br/>shape: circle/square/triangle"]:::model
        BreathSession["<b>BreathSession</b><br/>â”€â”€â”€<br/>exercises: List&lt;ExerciseSet&gt;<br/>tickSource: heartbeat/timer"]:::model

        ExerciseSet -->|"ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚"| ExerciseStep
        BreathSession -->|"ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚"| ExerciseSet
    end

    %% === Ğ¡Ğ›ĞĞ™ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ĞĞ’ ===
    subgraph Services["âš™ï¸ Services Layer"]
        direction TB
        ITickService["<b>ITickService</b><br/>â”€â”€â”€<br/>Stream&lt;TickData&gt; tickStream<br/>â”€â”€â”€<br/>Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ½Ğ¾Ğ¼<br/>~1 Ñ‚Ğ¸Ğº Ğ² ÑĞµĞºÑƒĞ½Ğ´Ñƒ"]:::service
        TickData["<b>TickData</b><br/>â”€â”€â”€<br/>intervalMs: int<br/>â”€â”€â”€<br/>Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»<br/>Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ‚Ğ¸ĞºĞ°Ğ¼Ğ¸"]:::service

        ITickService -->|"ÑĞ¼Ğ¸Ñ‚Ğ¸Ñ‚"| TickData
    end

    %% === Ğ¡Ğ›ĞĞ™ VIEWMODEL ===
    subgraph ViewModelLayer["ğŸ¯ ViewModel Layer"]
        direction TB

        BreathViewModel["<b>BreathViewModel</b><br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ:</b><br/>_exerciseIndex: Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ<br/>_repeatCounter: Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€<br/>_cycleTick: Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ² Ñ†Ğ¸ĞºĞ»Ğµ<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Lifecycle:</b><br/>initState() â†’ Ğ·Ğ°Ğ¿ÑƒÑĞº<br/>pause() / resume()<br/>complete() â†’ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Tick Processing:</b><br/>_onTick() â†’ Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€<br/>_onBreathTick() â†’ Ğ´Ñ‹Ñ…Ğ°Ğ½Ğ¸Ğµ<br/>_onRestTick() â†’ Ğ¾Ñ‚Ğ´Ñ‹Ñ…<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Transitions:</b><br/>_startRest()<br/>_startNewCycle()<br/>_advanceExercise()<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Helpers:</b><br/>getCurrentPhaseInfo()<br/>getNextPhaseInfo()<br/>getNextExerciseWithShape()"]:::viewmodel

        BreathSessionState["<b>BreathSessionState</b><br/>â”€â”€â”€<br/>status: pause/breath/rest/complete<br/>phase: inhale/hold/exhale/rest<br/>exerciseIndex: int<br/>remainingTicks: int<br/>currentIntervalMs: int"]:::viewmodel

        ResetStream["<b>resetStream</b><br/>â”€â”€â”€<br/>Stream&lt;ResetReason&gt;<br/>â”€â”€â”€<br/>newCycle: Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»<br/>rest: Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°<br/>exerciseChange: ÑĞ¼ĞµĞ½Ğ° ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ñ"]:::stream

        BreathViewModel -->|"ÑĞ¼Ğ¸Ñ‚Ğ¸Ñ‚"| BreathSessionState
        BreathViewModel -->|"ÑĞ¼Ğ¸Ñ‚Ğ¸Ñ‚"| ResetStream
    end

    %% === Ğ¡Ğ›ĞĞ™ ĞĞĞ˜ĞœĞĞ¦Ğ˜Ğ˜ ===
    subgraph AnimationLayer["ğŸ¨ Animation Layer"]
        direction TB

        BreathMotionEngine["<b>BreathMotionEngine</b><br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ¤Ğ¸Ğ·Ğ¸ĞºĞ° Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ:</b><br/>_position: 0.0 â†’ 1.0<br/>_currentVelocity<br/>_targetVelocity<br/>_smoothedIntervalMs<br/>_remainingTicks<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ ĞµĞ¶Ğ¸Ğ¼Ñ‹:</b><br/>Accelerating â†’ Linear<br/>ĞŸĞ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ 1.0<br/>Ğ·Ğ° remainingTicks<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>API:</b><br/>setActive(bool)<br/>setRemainingTicks(int)<br/>setIntervalMs(int)<br/>resetPosition(double)<br/>â”€â”€â”€<br/>â†’ normalizedPosition: 0..1"]:::animation

        BreathShapeShifter["<b>BreathShapeShifter</b><br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ“ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ:</b><br/>_currentPoints: 120 Ñ‚Ğ¾Ñ‡ĞµĞº<br/>_currentShape<br/>_morphProgress: 0..1<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ¤Ğ¾Ñ€Ğ¼Ñ‹:</b><br/>circle â†’ ĞºÑ€ÑƒĞ³<br/>square â†’ ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚<br/>triangleUp â†’ â–²<br/>triangleDown â†’ â–¼<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>ĞœĞ¾Ñ€Ñ„Ğ¸Ğ½Ğ³:</b><br/>morphTo(shape) â†’ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ 800ms<br/>ĞŸÑ€ÑĞ¼Ğ¾ÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ñ‹Ğµ: Ñ‡ĞµÑ€ĞµĞ· Path<br/>Ğ¡ ĞºÑ€ÑƒĞ³Ğ¾Ğ¼: Ñ‡ĞµÑ€ĞµĞ· interpolation<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>API:</b><br/>getCurrentPath() â†’ Path<br/>getPointPosition(time) â†’ Offset"]:::animation

        Coordinator["<b>BreathAnimationCoordinator</b><br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>ĞÑ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ:</b><br/>Ğ¡Ğ»ÑƒÑˆĞ°ĞµÑ‚ BreathSessionState<br/>Ğ¡Ğ»ÑƒÑˆĞ°ĞµÑ‚ resetStream<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:</b><br/>status â†’ motionEngine.setActive()<br/>remainingTicks â†’ setRemainingTicks()<br/>intervalMs â†’ setIntervalMs()<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>ĞœĞ¾Ñ€Ñ„Ğ¸Ğ½Ğ³:</b><br/>exerciseChange â†’ morphTo(shape)<br/>rest â†’ morphTo(shape)<br/>newCycle â†’ resetPosition()"]:::animation

        Coordinator -->|"ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚"| BreathMotionEngine
        Coordinator -->|"ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚"| BreathShapeShifter
    end

    %% === Ğ¡Ğ›ĞĞ™ UI ===
    subgraph UILayer["ğŸ–¼ï¸ UI Layer"]
        direction TB

        BreathSessionScreen["<b>BreathSessionScreen</b><br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚:</b><br/>BreathMotionEngine<br/>BreathShapeShifter<br/>BreathAnimationCoordinator<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Lifecycle:</b><br/>initState() â†’ initialize()<br/>dispose() â†’ cleanup<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚:</b><br/>BreathShapeWidget<br/>Ğ¢ĞµĞºÑƒÑ‰ÑƒÑ Ñ„Ğ°Ğ·Ñƒ<br/>Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ñ„Ğ°Ğ·Ñƒ<br/>ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ"]:::ui

        BreathWidget["<b>BreathShapeWidget</b><br/>â”€â”€â”€<br/>ListenableBuilder:<br/>motionController + shapeController<br/>â”€â”€â”€<br/>LayoutBuilder:<br/>updateBounds() Ğ¿Ñ€Ğ¸ resize<br/>â”€â”€â”€<br/>CustomPaint:<br/>BreathShapePainter"]:::ui

        BreathPainter["<b>BreathShapePainter</b><br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³:</b><br/>1. Ğ¤Ğ¸Ğ³ÑƒÑ€Ğ° (3 ÑĞ»Ğ¾Ñ):<br/>   - Outer glow<br/>   - Main stroke<br/>   - Inner highlight<br/>â”€â”€â”€<br/>2. Ğ¢Ğ¾Ñ‡ĞºĞ° (4 ÑĞ»Ğ¾Ñ):<br/>   - Outer glow<br/>   - Mid glow<br/>   - Main circle<br/>   - Center highlight<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/><b>Ğ’Ñ…Ğ¾Ğ´Ñ‹:</b><br/>shapeShifter.getCurrentPath()<br/>motionEngine.normalizedPosition"]:::ui

        BreathSessionScreen -->|"ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚"| BreathWidget
        BreathWidget -->|"Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚"| BreathPainter
    end

    %% === ĞŸĞĞ¢ĞĞšĞ˜ Ğ”ĞĞĞĞ«Ğ¥ ===

    %% ĞœĞ¾Ğ´ĞµĞ»Ğ¸ â†’ ViewModel
    BreathSession -.->|"Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ² ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€"| BreathViewModel

    %% Ğ¡ĞµÑ€Ğ²Ğ¸Ñ â†’ ViewModel
    ITickService -->|"tickStream"| BreathViewModel

    %% ViewModel â†’ Coordinator
    BreathViewModel -->|"state changes"| Coordinator
    BreathViewModel -->|"reset events"| Coordinator

    %% Coordinator â†’ Animation
    Coordinator -->|"ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚"| BreathMotionEngine
    Coordinator -->|"ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚"| BreathShapeShifter

    %% Animation â†’ UI
    BreathMotionEngine -.->|"notifyListeners()"| BreathWidget
    BreathShapeShifter -.->|"notifyListeners()"| BreathWidget
    BreathWidget -->|"Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ"| BreathPainter

    %% UI â†’ ViewModel
    BreathSessionScreen -.->|"pause() / resume()"| BreathViewModel
    BreathSessionScreen -.->|"Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ state"| BreathViewModel

    %% === Ğ›Ğ•Ğ“Ğ•ĞĞ”Ğ ===
    subgraph Legend["ğŸ“‹ Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°"]
        direction LR
        L1["ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"]:::model
        L2["Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹"]:::service
        L3["ViewModel"]:::viewmodel
        L4["ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ"]:::animation
        L5["UI"]:::ui
        L6["Ğ¡Ñ‚Ñ€Ğ¸Ğ¼Ñ‹"]:::stream
    end

    %% === ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• ĞŸĞĞ¢ĞĞšĞ˜ ===
    subgraph KeyFlows["ğŸ”„ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸"]
        direction TB
        Flow1["<b>1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</b><br/>Screen ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Engine + Shifter + Coordinator<br/>â†’ ViewModel.initState()<br/>â†’ Coordinator.initialize()"]
        Flow2["<b>2. Tick Loop</b><br/>TickService â†’ ViewModel._onTick()<br/>â†’ state update<br/>â†’ Coordinator ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Engine"]
        Flow3["<b>3. ĞœĞ¾Ñ€Ñ„Ğ¸Ğ½Ğ³</b><br/>ViewModel._advanceExercise()<br/>â†’ resetStream.add(exerciseChange)<br/>â†’ Coordinator._onReset()<br/>â†’ ShapeShifter.morphTo()"]
        Flow4["<b>4. Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³</b><br/>Engine/Shifter.notifyListeners()<br/>â†’ Widget rebuild<br/>â†’ Painter Ñ€Ğ¸ÑÑƒĞµÑ‚ Path + Ñ‚Ğ¾Ñ‡ĞºÑƒ"]
    end