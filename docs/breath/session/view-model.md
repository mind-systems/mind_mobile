# Поведение BreathViewModel

## Путешествие тика через систему дыхания

ViewModel получает каждую секунду сигнал от TickService и на его основе принимает решение о дальнейшем ходе сессии. Основанием для этого служит BreathSession со списком упражнений. Внутреннее состояние определяется тремя параметрами: индексом текущего упражнения (_exerciseIndex), номером повтора внутри упражнения (_repeatCounter) и позицией внутри текущего дыхательного цикла (_cycleTick).

## Старт сессии

При вызове initState ViewModel обращается к первому упражнению сессии. Возможны два сценария. Если первое упражнение является чистым отдыхом и не содержит шагов дыхания, а только restDuration, состояние сразу переводится в режим rest с фазой rest и remainingTicks, равным длительности отдыха. Если упражнение содержит шаги дыхания, вызывается _getCurrentStepData с нулевым тиком для определения начальной фазы, и состояние также устанавливается в паузу. Сессия всегда стартует в режиме pause; фактическое движение начинается только после вызова resume со стороны UI.

## Главный цикл обработки тиков

Каждое событие от TickService приводит к вызову _onTick с параметром прошедшего интервала в миллисекундах. Этот интервал сохраняется в state, чтобы визуальный слой мог использовать его для сглаживания анимаций. Далее проверяется текущий статус. Если сессия находится на паузе или завершена, тик игнорируется. Если статус breath, управление передаётся в _onBreathTick. Если статус rest, вызывается _onRestTick.

## Дыхательная фаза: _onBreathTick

Во время дыхания каждый тик увеличивает _cycleTick на единицу. Это значение отражает количество тиков с начала текущего цикла дыхания. Длительность цикла фиксирована и равна сумме длительностей всех шагов упражнения.

Сначала проверяется, достиг ли _cycleTick значения cycleDuration. Если цикл завершён, _cycleTick сбрасывается в ноль, а _repeatCounter увеличивается на единицу. Далее проверяется, достигнуто ли заданное количество повторов упражнения. Если да, упражнение считается завершённым и вызывается _advanceExercise. Если повторы ещё остаются, анализируется restDuration текущего упражнения. При наличии отдыха вызывается _startRest, в противном случае сразу запускается следующий цикл через _startNewCycle.

Если цикл ещё продолжается, вызывается _getCurrentStepData с текущим значением _cycleTick. Метод определяет, в каком шаге дыхания находится система, и возвращает тип фазы и количество тиков, оставшихся до конца цикла. Эти данные формируют новое состояние, которое передаётся наружу.

## Фаза отдыха: _onRestTick

Во время отдыха каждый тик также увеличивает _cycleTick. Количество оставшихся тиков вычисляется как restDuration минус _cycleTick. Когда _cycleTick достигает restDuration, отдых считается завершённым.

На этом этапе определяется тип отдыха. Если текущее упражнение не содержит шагов дыхания, значит это отдельное упражнение-отдых, и вызывается _advanceExercise. Если шаги присутствуют, отдых был промежуточным между циклами, и запускается следующий цикл того же упражнения через _startNewCycle.

Если отдых ещё продолжается, обновляется state с фазой rest и актуальным значением remainingTicks.

## Завершение упражнения и переходы

Метод _advanceExercise увеличивает _exerciseIndex и проверяет, остались ли упражнения в сессии. Если индекс выходит за пределы списка, вызывается complete, который переводит статус в complete, отменяет подписку на тики и закрывает resetStream.

Если упражнения ещё есть, вызывается _resetCycleInternal, обнуляющий _cycleTick и _repeatCounter. Затем в resetStream отправляется событие, сигнализирующее визуальному слою о полном изменении контекста и необходимости сброса формы и позиции точки.

Далее анализируется следующее упражнение. Если у него нет шагов дыхания и задан restDuration, запускается _startRest. Если шаги присутствуют, начинается дыхание через _startNewCycle.

Отдых, заданный внутри упражнения, используется только между циклами и не применяется после последнего повтора. Отдых между упражнениями возможен только в том случае, если он оформлен как отдельное упражнение.

## Переходные методы

Метод _startRest сбрасывает _cycleTick, отправляет событие в resetStream и формирует state со статусом rest, фазой rest и remainingTicks, равным полной длительности отдыха.

Метод _startNewCycle также отправляет событие в resetStream, определяет параметры первого шага нового цикла через _getCurrentStepData с нулевым тиком и формирует state со статусом breath.

## Определение текущего шага

Метод _getCurrentStepData принимает номер тика внутри цикла и проходит по списку шагов упражнения, накапливая их длительности. Для каждого шага проверяется, попадает ли текущий тик в его диапазон. После нахождения соответствующего шага вычисляется количество тиков, оставшихся до конца цикла, и тип шага преобразуется в фазу дыхания. В случае выхода за пределы шагов возвращаются параметры последнего шага как fallback.

## Публичные методы для UI

Метод getCurrentPhaseInfo возвращает информацию о текущей фазе, включая количество тиков до её завершения. Для отдыха возвращаются параметры rest, для дыхания — остаток текущего шага.

Метод getNextPhaseInfo определяет следующую фазу. В рамках дыхания он анализирует следующий шаг, затем возможный отдых между циклами или начало нового цикла. При завершении упражнения анализируется следующее упражнение сессии. Если дальнейших фаз нет, возвращается null.

## Управление сессией

Метод pause переводит статус в pause без изменения остальных параметров. В этом состоянии входящие тики игнорируются. Метод resume восстанавливает статус в breath или rest в зависимости от текущей фазы. Метод complete завершает сессию, отменяет подписку на TickService и закрывает поток resetStream.
